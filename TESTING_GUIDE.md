# Руководство по тестированию - Рисование онлайн

## Установка зависимостей

### Серверная часть
```bash
cd server
npm install
```

### Клиентская часть
```bash
cd client
npm install
```

---

## Запуск тестов

### Серверные тесты

```bash
cd server

# Запустить все тесты
npm test

# Запустить тесты в режиме watch
npm run test:watch

# Запустить тесты с покрытием кода
npm run test:coverage
```

### Клиентские тесты

```bash
cd client

# Запустить все тесты
npm test

# Запустить тесты в режиме watch
npm run test:watch

# Запустить тесты с покрытием кода
npm run test:coverage
```

---

## Структура тестов

### Серверные тесты (`server/__tests__/`)

```
server/
  __tests__/
    server.test.js          # API endpoints, безопасность, редиректы
  jest.config.js            # Конфигурация Jest
```

**Покрытие:**
- ✅ POST /rooms - создание комнат
- ✅ GET /rooms/public - список публичных комнат
- ✅ GET /rooms/:id/exists - проверка существования комнаты
- ✅ POST /rooms/:id/verify-password - проверка пароля
- ✅ Санитизация входных данных
- ✅ Защита от XSS
- ✅ Редиректы доменов
- ✅ WebSocket валидация

### Клиентские тесты (`client/src/__tests__/`)

```
client/src/
  __tests__/
    canvasState.test.js     # Управление состоянием холста
    tools.test.js           # Инструменты рисования
    websocket.test.js       # WebSocket синхронизация
  __mocks__/
    fileMock.js            # Моки для файлов
  setupTests.js            # Настройка тестового окружения
  jest.config.js           # Конфигурация Jest
  .babelrc                 # Конфигурация Babel
```

**Покрытие:**
- ✅ CanvasState - управление штрихами, undo/redo
- ✅ Все 10 инструментов рисования
- ✅ WebSocket синхронизация
- ✅ Управление пользователями
- ✅ Чат
- ✅ Валидация данных

---

## Описание тестов

### 1. Серверные API тесты

#### POST /rooms
- Создание публичной комнаты
- Создание приватной комнаты с паролем
- Отклонение запроса без имени
- Санитизация имени комнаты
- Ограничение длины имени (100 символов)

#### GET /rooms/public
- Получение списка публичных комнат
- Проверка структуры данных

#### GET /rooms/:id/exists
- Проверка несуществующей комнаты
- Проверка существующей комнаты

#### POST /rooms/:id/verify-password
- Проверка правильного пароля
- Отклонение неправильного пароля
- Обработка несуществующей комнаты

#### Тесты безопасности
- Санитизация XSS в именах пользователей
- Ограничение длины сообщений
- Обработка некорректных типов данных

#### Тесты редиректов
- Редирект с www.risovanie.online
- Отсутствие редиректа для risovanie.online

### 2. Тесты состояния холста (CanvasState)

#### Управление штрихами
- Добавление штриха на холст
- Предотвращение дубликатов
- Очистка всех штрихов

#### Undo/Redo
- Отмена последнего штриха
- Повтор отмененного штриха
- Очистка стека redo при новом штрихе

#### Управление пользователями
- Установка имени пользователя
- Сброс имени пользователя
- Обрезка пробелов

#### Управление комнатами
- Установка ID комнаты
- Отслеживание статуса подключения
- Управление списком подключенных пользователей

#### Модальные окна
- Переключение интерфейса комнат
- Переключение окна "О программе"

#### Интеграция инструментов
- Обработка штрихов кисти
- Обработка фигур (прямоугольник, круг)
- Обработка стрелок
- Обработка многоугольников
- Обработка текста

### 3. Тесты инструментов рисования

#### Brush (Кисть)
- Создание экземпляра
- Установка composite operation
- Регистрация событий
- Рисование штриха

#### Eraser (Ластик)
- Создание экземпляра
- Установка composite operation на destination-out
- Восстановление composite operation при уничтожении

#### Line (Линия)
- Создание экземпляра
- Рисование линии между двумя точками

#### Rectangle (Прямоугольник)
- Создание экземпляра
- Рисование прямоугольника
- Обработка отрицательных размеров

#### Circle (Круг)
- Создание экземпляра
- Рисование круга

#### Arrow (Стрелка)
- Создание экземпляра
- Рисование стрелки с наконечником
- Расчет угла наконечника

#### Polygon (Многоугольник)
- Создание экземпляра
- Добавление точек
- Рисование многоугольника

#### Fill (Заливка)
- Создание экземпляра
- Получение данных изображения

#### Text (Текст)
- Создание экземпляра
- Рисование текста
- Измерение ширины текста

#### Общие свойства
- Установка цвета штриха
- Установка толщины линии
- Установка прозрачности

#### Очистка
- Удаление обработчиков событий
- Восстановление состояния холста

### 4. Тесты WebSocket синхронизации

#### Управление подключением
- Установка WebSocket соединения
- Отправка сообщения о подключении
- Обработка закрытия соединения
- Обработка ошибок соединения

#### Синхронизация рисования
- Отправка штриха кисти на сервер
- Получение и применение удаленного штриха
- Получение начального состояния холста
- Синхронизация отмены действия
- Синхронизация повтора действия
- Синхронизация очистки холста

#### Управление пользователями
- Добавление пользователя в список
- Удаление пользователя из списка
- Обновление списка пользователей
- Ограничение максимального количества пользователей (10)

#### Синхронизация чата
- Отправка сообщения в чат
- Получение сообщения из чата
- Санитизация сообщений
- Ограничение длины сообщений (500 символов)

#### Валидация сообщений
- Проверка структуры сообщения
- Валидация сообщения рисования

#### Логика переподключения
- Попытка переподключения при разрыве
- Восстановление состояния после переподключения

#### Тесты производительности
- Обработка быстрых обновлений штрихов
- Обработка больших массивов штрихов
- Обработка сообщений в пределах времени

---

## Требования к покрытию кода

### Серверная часть
- **Branches:** 80%
- **Functions:** 80%
- **Lines:** 85%
- **Statements:** 85%

### Клиентская часть
- **Branches:** 80%
- **Functions:** 80%
- **Lines:** 85%
- **Statements:** 85%

---

## Интерпретация результатов

### Успешное выполнение
```
PASS  __tests__/server.test.js
  ✓ should create a new room (15ms)
  ✓ should verify correct password (10ms)
  ...

Test Suites: 1 passed, 1 total
Tests:       25 passed, 25 total
Snapshots:   0 total
Time:        2.5s
```

### Отчет о покрытии
```
--------------------|---------|----------|---------|---------|
File                | % Stmts | % Branch | % Funcs | % Lines |
--------------------|---------|----------|---------|---------|
All files           |   87.5  |   82.3   |   85.7  |   87.1  |
 server.js          |   90.2  |   85.4   |   88.9  |   89.8  |
 canvasState.js     |   85.3  |   80.1   |   83.2  |   85.0  |
--------------------|---------|----------|---------|---------|
```

---

## Отладка тестов

### Запуск конкретного теста
```bash
# Серверные тесты
npm test -- server.test.js

# Клиентские тесты
npm test -- canvasState.test.js
```

### Запуск теста с конкретным названием
```bash
npm test -- -t "should create a new room"
```

### Подробный вывод
```bash
npm test -- --verbose
```

### Отладка в VS Code
Добавьте конфигурацию в `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Jest Tests",
      "program": "${workspaceFolder}/node_modules/.bin/jest",
      "args": ["--runInBand"],
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen"
    }
  ]
}
```

---

## Continuous Integration (CI)

### GitHub Actions пример

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'
    
    - name: Install server dependencies
      run: cd server && npm install
    
    - name: Run server tests
      run: cd server && npm test
    
    - name: Install client dependencies
      run: cd client && npm install
    
    - name: Run client tests
      run: cd client && npm test
    
    - name: Upload coverage
      uses: codecov/codecov-action@v2
```

---

## Часто встречающиеся проблемы

### 1. Ошибка "Cannot find module"
**Решение:** Убедитесь, что установлены все зависимости:
```bash
npm install
```

### 2. Тесты падают с timeout
**Решение:** Увеличьте timeout в jest.config.js:
```javascript
testTimeout: 10000
```

### 3. Canvas API не работает в тестах
**Решение:** Убедитесь, что `setupTests.js` правильно настроен с моками для Canvas.

### 4. WebSocket ошибки
**Решение:** Используйте моки WebSocket из `setupTests.js`.

---

## Лучшие практики

1. **Изолированность тестов:** Каждый тест должен быть независимым
2. **Очистка состояния:** Используйте `beforeEach` для сброса состояния
3. **Моки:** Мокируйте внешние зависимости (WebSocket, API)
4. **Описательные названия:** Используйте понятные названия тестов
5. **Один assert на тест:** Тестируйте одну вещь за раз
6. **Покрытие:** Стремитесь к 85%+ покрытию
7. **Производительность:** Тесты должны выполняться быстро (< 5 сек)

---

## Дополнительные ресурсы

- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [Testing Library](https://testing-library.com/docs/react-testing-library/intro/)
- [Supertest Documentation](https://github.com/visionmedia/supertest)

---

**Дата обновления:** Январь 2026  
**Версия:** 2.0
